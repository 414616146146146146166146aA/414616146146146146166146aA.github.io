<? php
/ **
 * Действие для добавления и редактирования комментариев
 * /

$ entity_guid = ( int ) get_input ( 'entity_guid' , 0 , ложь );
$ comment_guid = ( int ) get_input ( 'comment_guid' , 0 , ложь );
$ comment_text = get_input ( 'generic_comment' );

if ( empty ( $ comment_text )) {
	вернуть  elgg_error_response ( elgg_echo ( 'generic_comment: blank' ));
}

if ( $ comment_guid ) {
	// Редактировать существующий комментарий
	$ comment = get_entity ( $ comment_guid );

	if (! $ comment instanceof ElggComment ) {
		вернуть  elgg_error_response ( elgg_echo ( 'generic_comment: notfound' ));
	}
	if (! $ comment -> canEdit ()) {
		вернуть  elgg_error_response ( elgg_echo ( 'actionunauthorized' ));
	}

	$ comment -> description = $ comment_text ;
	if (! $ comment -> save ()) {
		вернуть  elgg_error_response ( elgg_echo ( 'generic_comment: failure' ));
	}
	
	$ success_message = elgg_echo ( 'generic_comment: обновлено' );
} else {
	// Создаем новый комментарий к целевой сущности
	$ entity = get_entity ( $ entity_guid );
	if (! $ entity ) {
		вернуть  elgg_error_response ( elgg_echo ( 'generic_comment: notfound' ));
	}

	$ user = elgg_get_logged_in_user_entity ();

	$ comment = новый  ElggComment ();
	$ comment -> description = $ comment_text ;
	$ comment -> owner_guid = $ user -> getGUID ();
	$ comment -> container_guid = $ entity -> getGUID ();
	$ комментарий -> access_id = $ entity -> access_id ;
	$ guid = $ comment -> save ();

	if (! $ guid ) {
		вернуть  elgg_error_response ( elgg_echo ( 'generic_comment: failure' ));
	}

	// Добавить в реку
	elgg_create_river_item ([
		'view' => 'река / объект / комментарий / создать' ,
		'action_type' => 'комментарий' ,
		'object_guid' => $ guid ,
		'target_guid' => $ entity_guid ,
	]);

	$ success_message = elgg_echo ( 'общий_коммент: опубликовано' );
}

$ forward = $ comment -> getURL ();

// возвращаемся на страницу активности, если опубликовано оттуда
// это может быть удалено после того, как будут сохранены новые комментарии ajaxed
if (! пусто ( $ _SERVER [ 'HTTP_REFERER' ])) {
	// не перенаправлять на URL-адреса от клиента без проверки на сайте
	$ site_url = preg_quote ( elgg_get_site_url (), '~' );
	if ( preg_match ( "~ ^ {$ site_url} activity (/ | \\ z) ~" , $ _SERVER [ 'HTTP_REFERER' ], $ m )) {
		$ forward = "{$ m [0]} # elgg-object - {$ comment-> guid}" ;
	}
}

$ result = [
	'guid' => $ comment -> guid ,
	'output' => elgg_view_entity ( $ комментарий ),
];

return  elgg_ok_response ( $ result , $ success_message , $ forward );
